<script src="https://cdn.jsdelivr.net/npm/particle-api-js@8/dist/particle.min.js"></script>
<script>
    // Particle API initialiseren
    const particle = new Particle();
    const token = 'ba9d9e1ed9f70cc5db24de2db21764a3a3afe28b';

    // Lijst van controllers met hun device ID's
    const controllers = [
        { name: 'R1-BandB', deviceId: '30002c000547343233323032' },
        { name: 'R2-BADK', deviceId: '5600420005504b464d323520' },
        { name: 'R3-INKOM', deviceId: '420035000e47343432313031' },
        { name: 'R4-KEUK', deviceId: '310017001647373335333438' },
        { name: 'R5-WASPL', deviceId: '33004f000e504b464d323520' },
        { name: 'R6-EETPL', deviceId: '210042000b47343432313031' },
        { name: 'R7-ZITPL', deviceId: '410038000547353138383138' }
    ];

    // Variabelen in de volgorde van de kolommen
    const variables = ['v', 'w', 'x', 'g', 'h', 'd', 'c', 'k', 'e', 'b', 'a', 'l', 'i', 'm', 'j', 'n', 'o', 'p', 'f', 'q', 'r', 's', 't', 'u'];

    // Kleurregels per kolom (gebaseerd op de labels en jouw specificaties)
    const columnRules = {
        'Strength': { min: 0, max: 100, minColor: 'red', maxColor: 'green' }, // v
        'Quality': { min: 0, max: 100, minColor: 'red', maxColor: 'green' }, // w
        'FreeMem': { min: 0, max: 84, minColor: 'red', maxColor: 'green' }, // x
        'Temp1': { min: 15, max: 25, minColor: 'blue', maxColor: 'red' }, // g
        'Temp2': { min: 15, max: 25, minColor: 'blue', maxColor: 'red' }, // h
        'Humi': { min: 0, max: 60, minColor: 'white', maxColor: 'blue' }, // d
        'Dew': { special: true }, // c (speciale regel: vergelijking met Temp1)
        'DewAlert': { min: 0, max: 1, minColor: 'green', maxColor: 'red' }, // k
        'Light': { min: 0, max: 20, minColor: 'gray', maxColor: 'yellow' }, // e
        'Dust': { min: 0, max: 100, minColor: 'white', maxColor: 'black' }, // b
        'CO2': { min: 0, max: 800, minColor: 'white', maxColor: 'red' }, // a
        'TSTATon': { min: 0, max: 1, minColor: 'white', maxColor: 'red' }, // l
        'MOV1': { min: 0, max: 100, minColor: 'white', maxColor: 'black' }, // i
        'MOV1light': { min: 0, max: 1, minColor: 'white', maxColor: 'yellow' }, // m
        'MOV2': { min: 0, max: 100, minColor: 'white', maxColor: 'black' }, // j
        'MOV2light': { min: 0, max: 1, minColor: 'white', maxColor: 'yellow' }, // n
        'BEAMalert': { min: 0, max: 1, minColor: 'white', maxColor: 'yellow' }, // o
        'BEAMlight': { min: 0, max: 1, minColor: 'white', maxColor: 'yellow' }, // p
        'SUNLight': { min: 0, max: 5000, minColor: 'white', maxColor: 'yellow' }, // f
        'Night': { min: 0, max: 1, minColor: 'white', maxColor: 'black' }, // q
        'Bed': { min: 0, max: 1, minColor: 'white', maxColor: 'black' }, // r
        'R': { min: 0, max: 255, minColor: 'white', maxColor: 'red' }, // s
        'G': { min: 0, max: 255, minColor: 'white', maxColor: 'green' }, // t
        'B': { min: 0, max: 255, minColor: 'white', maxColor: 'blue' } // u
    };

    // Functie om RGB-waarde te interpoleren tussen twee kleuren
    function interpolateColor(value, min, max, minColor, maxColor) {
        if (value === 'Onbekend' || isNaN(parseFloat(value))) return '#ffffff'; // Wit als standaard bij ongeldige data

        const ratio = Math.min(Math.max((parseFloat(value) - min) / (max - min), 0), 1);
        const colorMap = {
            'red': [255, 0, 0], 'green': [0, 255, 0], 'blue': [0, 0, 255],
            'white': [255, 255, 255], 'black': [0, 0, 0], 'yellow': [255, 255, 0],
            'gray': [128, 128, 128]
        };

        const c1 = colorMap[minColor] || [255, 255, 255];
        const c2 = colorMap[maxColor] || [255, 255, 255];
        const r = Math.round(c1[0] + (c2[0] - c1[0]) * ratio);
        const g = Math.round(c1[1] + (c2[1] - c1[1]) * ratio);
        const b = Math.round(c1[2] + (c2[2] - c1[2]) * ratio);

        return `rgb(${r}, ${g}, ${b})`;
    }

    // Functie om de achtergrondkleur van een cel in te stellen
    function setCellColor(element, value, columnName, temp1Value = null) {
        if (columnName === 'Dew') {
            if (temp1Value === null || value === 'Onbekend' || temp1Value === 'Onbekend') {
                element.style.backgroundColor = '#ffffff';
            } else {
                element.style.backgroundColor = parseFloat(temp1Value) < parseFloat(value) ? 'red' : 'green';
            }
        } else {
            const rule = columnRules[columnName];
            if (!rule || value === 'Onbekend') {
                element.style.backgroundColor = '#ffffff';
            } else {
                element.style.backgroundColor = interpolateColor(value, rule.min, rule.max, rule.minColor, rule.maxColor);
            }
        }
        // Zorg dat tekst leesbaar blijft door de tekstkleur aan te passen
        const bgColor = element.style.backgroundColor;
        const luminance = bgColor.match(/\d+/g) ? (0.299 * bgColor.match(/\d+/g)[0] + 0.587 * bgColor.match(/\d+/g)[1] + 0.114 * bgColor.match(/\d+/g)[2]) : 255;
        element.style.color = luminance < 128 ? '#ffffff' : '#333';
    }

    // Functie om de status van een controller bij te werken
    function updateControllerStatus(controllerName, data) {
        const temp1Value = data['g'] !== undefined ? data['g'] : 'Onbekend'; // Temp1 waarde voor Dew-vergelijking
        variables.forEach((variable, index) => {
            const element = document.getElementById(`${controllerName}-${variable}`);
            const columnName = Object.keys(columnRules)[index];
            const value = data[variable] !== undefined ? data[variable] : 'Onbekend';
            element.textContent = value;
            setCellColor(element, value, columnName, columnName === 'Dew' ? temp1Value : null);
        });
    }

    // Functie om de status van een controller op te halen
    function fetchStatus(controller) {
        particle.getVariable({ deviceId: controller.deviceId, name: 'JSON_status', auth: token })
            .then(data => {
                console.log(`API-respons voor ${controller.name}:`, data);
                if (data && data.body && data.body.result) {
                    const jsonData = JSON.parse(data.body.result);
                    updateControllerStatus(controller.name, jsonData);
                } else {
                    throw new Error('Ongeldige respons: geen "result" veld');
                }
            })
            .catch(err => {
                console.error(`Fout bij ophalen van variabele voor ${controller.name}:`, err);
                updateControllerStatus(controller.name, {});
            });
    }

    // Haal de status op voor alle controllers
    function fetchAllStatuses() {
        controllers.forEach(controller => {
            fetchStatus(controller);
        });
    }

    // Start de initiÃ«le ophaling bij het laden van de pagina
    fetchAllStatuses();
</script>
