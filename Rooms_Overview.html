<!DOCTYPE html>
<html>
<head>
    <title>Zarlardinge Schuur - Room Controllers</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            background-image: url("BG.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            color: #333;
            margin: 20px;
        }
        h1 { font-size: 18px; margin-bottom: 20px; }
        .table-container {
            max-width: 100%; overflow-x: auto; background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px; padding: 15px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 8px; text-align: center; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2; }
        td { background-color: #fff; }
        tr:nth-child(even) td { background-color: #f9f9f9; }
        .controller-name {
            font-weight: bold; text-align: left; position: sticky; left: 0; background-color: #fff;
            z-index: 1; min-width: 100px;
        }
        tr:nth-child(even) .controller-name { background-color: #f9f9f9; }
        .button-container { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .update-button, .home-button {
            padding: 10px 20px; background-color: #007bff; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center;
        }
        .update-button:hover, .home-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>Zarlardinge Schuur - Overzicht Room Controllers</h1>
    <div class="table-container">
        <table id="status-table">
            <thead>
                <tr>
                    <th>Controller</th>
                    <th>Strength</th><th>Quality</th><th>FreeMem</th><th>Temp1</th><th>Temp2</th><th>Humi</th><th>Dew</th><th>DewAlert</th>
                    <th>Light</th><th>Dust</th><th>CO2</th><th>TSTATon</th><th>MOV1</th><th>MOV1light</th><th>MOV2</th><th>MOV2light</th>
                    <th>BEAMalert</th><th>BEAMlight</th><th>SUNLight</th><th>Night</th><th>Bed</th><th>R</th><th>G</th><th>B</th>
                </tr>
            </thead>
            <tbody>
                <!-- Exact dezelfde rijen als voorheen, alleen "Laden…" i.p.v. "Onbekend" -->
                <tr id="R1-BandB"><td class="controller-name">R1-BandB</td><td id="R1-BandB-v">Laden…</td><td id="R1-BandB-w">Laden…</td><td id="R1-BandB-x">Laden…</td><td id="R1-BandB-g">Laden…</td><td id="R1-BandB-h">Laden…</td><td id="R1-BandB-d">Laden…</td><td id="R1-BandB-c">Laden…</td><td id="R1-BandB-k">Laden…</td><td id="R1-BandB-e">Laden…</td><td id="R1-BandB-b">Laden…</td><td id="R1-BandB-a">Laden…</td><td id="R1-BandB-l">Laden…</td><td id="R1-BandB-i">Laden…</td><td id="R1-BandB-m">Laden…</td><td id="R1-BandB-j">Laden…</td><td id="R1-BandB-n">Laden…</td><td id="R1-BandB-o">Laden…</td><td id="R1-BandB-p">Laden…</td><td id="R1-BandB-f">Laden…</td><td id="R1-BandB-q">Laden…</td><td id="R1-BandB-r">Laden…</td><td id="R1-BandB-s">Laden…</td><td id="R1-BandB-t">Laden…</td><td id="R1-BandB-u">Laden…</td></tr>
                <tr id="R2-BADK"><td class="controller-name">R2-BADK</td><td id="R2-BADK-v">Laden…</td><td id="R2-BADK-w">Laden…</td><td id="R2-BADK-x">Laden…</td><td id="R2-BADK-g">Laden…</td><td id="R2-BADK-h">Laden…</td><td id="R2-BADK-d">Laden…</td><td id="R2-BADK-c">Laden…</td><td id="R2-BADK-k">Laden…</td><td id="R2-BADK-e">Laden…</td><td id="R2-BADK-b">Laden…</td><td id="R2-BADK-a">Laden…</td><td id="R2-BADK-l">Laden…</td><td id="R2-BADK-i">Laden…</td><td id="R2-BADK-m">Laden…</td><td id="R2-BADK-j">Laden…</td><td id="R2-BADK-n">Laden…</td><td id="R2-BADK-o">Laden…</td><td id="R2-BADK-p">Laden…</td><td id="R2-BADK-f">Laden…</td><td id="R2-BADK-q">Laden…</td><td id="R2-BADK-r">Laden…</td><td id="R2-BADK-s">Laden…</td><td id="R2-BADK-t">Laden…</td><td id="R2-BADK-u">Laden…</td></tr>
                <tr id="R3-INKOM"><td class="controller-name">R3-INKOM</td><td id="R3-INKOM-v">Laden…</td><td id="R3-INKOM-w">Laden…</td><td id="R3-INKOM-x">Laden…</td><td id="R3-INKOM-g">Laden…</td><td id="R3-INKOM-h">Laden…</td><td id="R3-INKOM-d">Laden…</td><td id="R3-INKOM-c">Laden…</td><td id="R3-INKOM-k">Laden…</td><td id="R3-INKOM-e">Laden…</td><td id="R3-INKOM-b">Laden…</td><td id="R3-INKOM-a">Laden…</td><td id="R3-INKOM-l">Laden…</td><td id="R3-INKOM-i">Laden…</td><td id="R3-INKOM-m">Laden…</td><td id="R3-INKOM-j">Laden…</td><td id="R3-INKOM-n">Laden…</td><td id="R3-INKOM-o">Laden…</td><td id="R3-INKOM-p">Laden…</td><td id="R3-INKOM-f">Laden…</td><td id="R3-INKOM-q">Laden…</td><td id="R3-INKOM-r">Laden…</td><td id="R3-INKOM-s">Laden…</td><td id="R3-INKOM-t">Laden…</td><td id="R3-INKOM-u">Laden…</td></tr>
                <tr id="R4-KEUK"><td class="controller-name">R4-KEUK</td><td id="R4-KEUK-v">Laden…</td><td id="R4-KEUK-w">Laden…</td><td id="R4-KEUK-x">Laden…</td><td id="R4-KEUK-g">Laden…</td><td id="R4-KEUK-h">Laden…</td><td id="R4-KEUK-d">Laden…</td><td id="R4-KEUK-c">Laden…</td><td id="R4-KEUK-k">Laden…</td><td id="R4-KEUK-e">Laden…</td><td id="R4-KEUK-b">Laden…</td><td id="R4-KEUK-a">Laden…</td><td id="R4-KEUK-l">Laden…</td><td id="R4-KEUK-i">Laden…</td><td id="R4-KEUK-m">Laden…</td><td id="R4-KEUK-j">Laden…</td><td id="R4-KEUK-n">Laden…</td><td id="R4-KEUK-o">Laden…</td><td id="R4-KEUK-p">Laden…</td><td id="R4-KEUK-f">Laden…</td><td id="R4-KEUK-q">Laden…</td><td id="R4-KEUK-r">Laden…</td><td id="R4-KEUK-s">Laden…</td><td id="R4-KEUK-t">Laden…</td><td id="R4-KEUK-u">Laden…</td></tr>
                <tr id="R5-WASPL"><td class="controller-name">R5-WASPL</td><td id="R5-WASPL-v">Laden…</td><td id="R5-WASPL-w">Laden…</td><td id="R5-WASPL-x">Laden…</td><td id="R5-WASPL-g">Laden…</td><td id="R5-WASPL-h">Laden…</td><td id="R5-WASPL-d">Laden…</td><td id="R5-WASPL-c">Laden…</td><td id="R5-WASPL-k">Laden…</td><td id="R5-WASPL-e">Laden…</td><td id="R5-WASPL-b">Laden…</td><td id="R5-WASPL-a">Laden…</td><td id="R5-WASPL-l">Laden…</td><td id="R5-WASPL-i">Laden…</td><td id="R5-WASPL-m">Laden…</td><td id="R5-WASPL-j">Laden…</td><td id="R5-WASPL-n">Laden…</td><td id="R5-WASPL-o">Laden…</td><td id="R5-WASPL-p">Laden…</td><td id="R5-WASPL-f">Laden…</td><td id="R5-WASPL-q">Laden…</td><td id="R5-WASPL-r">Laden…</td><td id="R5-WASPL-s">Laden…</td><td id="R5-WASPL-t">Laden…</td><td id="R5-WASPL-u">Laden…</td></tr>
                <tr id="R6-EETPL"><td class="controller-name">R6-EETPL</td><td id="R6-EETPL-v">Laden…</td><td id="R6-EETPL-w">Laden…</td><td id="R6-EETPL-x">Laden…</td><td id="R6-EETPL-g">Laden…</td><td id="R6-EETPL-h">Laden…</td><td id="R6-EETPL-d">Laden…</td><td id="R6-EETPL-c">Laden…</td><td id="R6-EETPL-k">Laden…</td><td id="R6-EETPL-e">Laden…</td><td id="R6-EETPL-b">Laden…</td><td id="R6-EETPL-a">Laden…</td><td id="R6-EETPL-l">Laden…</td><td id="R6-EETPL-i">Laden…</td><td id="R6-EETPL-m">Laden…</td><td id="R6-EETPL-j">Laden…</td><td id="R6-EETPL-n">Laden…</td><td id="R6-EETPL-o">Laden…</td><td id="R6-EETPL-p">Laden…</td><td id="R6-EETPL-f">Laden…</td><td id="R6-EETPL-q">Laden…</td><td id="R6-EETPL-r">Laden…</td><td id="R6-EETPL-s">Laden…</td><td id="R6-EETPL-t">Laden…</td><td id="R6-EETPL-u">Laden…</td></tr>
                <tr id="R7-ZITPL"><td class="controller-name">R7-ZITPL</td><td id="R7-ZITPL-v">Laden…</td><td id="R7-ZITPL-w">Laden…</td><td id="R7-ZITPL-x">Laden…</td><td id="R7-ZITPL-g">Laden…</td><td id="R7-ZITPL-h">Laden…</td><td id="R7-ZITPL-d">Laden…</td><td id="R7-ZITPL-c">Laden…</td><td id="R7-ZITPL-k">Laden…</td><td id="R7-ZITPL-e">Laden…</td><td id="R7-ZITPL-b">Laden…</td><td id="R7-ZITPL-a">Laden…</td><td id="R7-ZITPL-l">Laden…</td><td id="R7-ZITPL-i">Laden…</td><td id="R7-ZITPL-m">Laden…</td><td id="R7-ZITPL-j">Laden…</td><td id="R7-ZITPL-n">Laden…</td><td id="R7-ZITPL-o">Laden…</td><td id="R7-ZITPL-p">Laden…</td><td id="R7-ZITPL-f">Laden…</td><td id="R7-ZITPL-q">Laden…</td><td id="R7-ZITPL-r">Laden…</td><td id="R7-ZITPL-s">Laden…</td><td id="R7-ZITPL-t">Laden…</td><td id="R7-ZITPL-u">Laden…</td></tr>
            </tbody>
        </table>
    </div>
    <div class="button-container">
        <button class="update-button" onclick="fetchAllStatuses()">Update!</button>
        <a href="index.html" class="home-button">Home</a>
    </div>

<script>
// ==== TOKEN VEILIG OPHALEN VAN JE WORKER ====
let PARTICLE_TOKEN = null;
async function getToken() {
    if (PARTICLE_TOKEN) return PARTICLE_TOKEN;
    try {
        const res = await fetch('https://controllers-diagnose.filip-delannoy.workers.dev/token');
        const data = await res.json();
        PARTICLE_TOKEN = data.token;
        return PARTICLE_TOKEN;
    } catch (e) {
        console.error("Kon token niet ophalen!", e);
        alert("Geen verbinding met server – data kan niet opgehaald worden.");
        return null;
    }
}

// Controllers + variabelen (exact zoals voorheen)
const controllers = [
    { name: 'R1-BandB', deviceId: '30002c000547343233323032' },
    { name: 'R2-BADK', deviceId: '5600420005504b464d323520' },
    { name: 'R3-INKOM', deviceId: '420035000e47343432313031' },
    { name: 'R4-KEUK', deviceId: '310017001647373335333438' },
    { name: 'R5-WASPL', deviceId: '33004f000e504b464d323520' },
    { name: 'R6-EETPL', deviceId: '210042000b47343432313031' },
    { name: 'R7-ZITPL', deviceId: '410038000547353138383138' }
];
const variables = ['v','w','x','g','h','d','c','k','e','b','a','l','i','m','j','n','o','p','f','q','r','s','t','u'];
const columnNames = ['Strength','Quality','FreeMem','Temp1','Temp2','Humi','Dew','DewAlert','Light','Dust','CO2','TSTATon','MOV1','MOV1light','MOV2','MOV2light','BEAMalert','BEAMlight','SUNLight','Night','Bed','R','G','B'];

const columnRules = { /* exact hetzelfde als voorheen */ };

function interpolateColor(value, min, max, minColor, maxColor) {
    if (value === 'Onbekend' || isNaN(parseFloat(value))) return '#ffffff';
    const ratio = Math.min(Math.max((parseFloat(value) - min) / (max - min), 0), 1);
    const colorMap = { red:[255,0,0], green:[0,255,0], blue:[0,0,255], white:[255,255,255], black:[0,0,0], yellow:[255,255,0], gray:[128,128,128] };
    const c1 = colorMap[minColor] || [255,255,255];
    const c2 = colorMap[maxColor] || [255,255,255];
    const r = Math.round(c1[0] + (c2[0]-c1[0]) * ratio);
    const g = Math.round(c1[1] + (c2[1]-c1[1]) * ratio);
    const b = Math.round(c1[2] + (c2[2]-c1[2]) * ratio);
    return `rgb(${r},${g},${b})`;
}

function setCellColor(el, value, colName, temp1) {
    if (colName === 'Dew') {
        if (value === 'Onbekend' || temp1 === 'Onbekend') el.style.backgroundColor = '#ffffff';
        else el.style.backgroundColor = parseFloat(temp1) < parseFloat(value) ? '#ff4444' : '#44aa44';
    } else {
        const rule = columnRules[colName];
        el.style.backgroundColor = rule ? interpolateColor(value, rule.min, rule.max, rule.minColor, rule.maxColor) : '#ffffff';
    }
    const lum = el.style.backgroundColor.match(/\d+/g);
    if (lum) el.style.color = (0.299*lum[0] + 0.587*lum[1] + 0.114*lum[2] < 128) ? '#fff' : '#333';
}

async function fetchStatus(controller) {
    const token = await getToken();
    if (!token) return;

    try {
        const resp = await fetch(`https://api.particle.io/v1/devices/${controller.deviceId}/JSON_status?access_token=${token}`);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const json = await resp.json();
        let result = json.result || json.body?.result;
        if (typeof result === "string") result = JSON.parse(result);

        const temp1 = result?.g ?? 'Onbekend';
        variables.forEach((v, i) => {
            const el = document.getElementById(`${controller.name}-${v}`);
            const val = result?.[v] ?? 'Onbekend';
            el.textContent = val;
            setCellColor(el, val, columnNames[i], columnNames[i] === 'Dew' ? temp1 : null);
        });
    } catch (err) {
        console.error(`Fout ${controller.name}:`, err);
        variables.forEach(v => {
            const el = document.getElementById(`${controller.name}-${v}`);
            if (el) el.textContent = 'Fout';
        });
    }
}

function fetchAllStatuses() {
    controllers.forEach(fetchStatus);
}

// Start direct bij laden
fetchAllStatuses();
</script>
</body>
</html>
