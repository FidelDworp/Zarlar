<!DOCTYPE html>
<html>
<head>
    <title>Zarlardinge Schuur - S-HVAC Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { background-image: url("BG.jpg"); background-size: cover; background-repeat: no-repeat; font-family: Arial, sans-serif; color: #333; margin: 20px; }
        h1 { font-size: 18px; margin-bottom: 20px; text-align: center; }
        .boiler-container { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; }
        .boiler { text-align: center; }
        .boiler-name { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .boiler-layers { width: 100px; height: 200px; border: 2px solid #333; border-radius: 8px; display: flex; flex-direction: column; }
        .boiler-layer { flex: 1; border-bottom: 1px solid #333; box-sizing: border-box; position: relative; display: flex; align-items: center; justify-content: center; }
        .boiler-layer:last-child { border-bottom: none; }
        .boiler-layer span { font-size: 10px; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        .boiler-info-container { background-color: rgba(255,255,255,0.8); border-radius: 8px; padding: 10px; max-width: 400px; margin: 0 auto; margin-bottom: 20px; display: flex; justify-content: space-around; gap: 20px; }
        .boiler-info { font-size: 16pt; text-align: center; flex: 1; }
        .heating-container { background-color: rgba(255,255,255,0.8); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto; margin-bottom: 20px; }
        .heat-demand { font-size: 18pt; text-align: center; margin-bottom: 10px; }
        .heating-container td:first-child { font-weight: bold; padding: 8px 10px; text-align: left; background-color: rgb(200,200,200); color: #000; border-radius: 4px; }
        .heating-container .toggle-wrapper table td:nth-child(4) { background-color: transparent !important; }
        .status-container { background-color: rgba(255,255,255,0.8); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        tr { border-bottom: 1px solid #ddd; }
        td { padding: 8px 10px; text-align: center; }
        .label { font-weight: bold; margin-right: 5px; }
        .relay-on { background-color: #ff0000; color: #fff; }
        .button-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .update-button, .home-button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center; }
        .update-button:hover, .home-button:hover { background-color: #0056b3; }
        .toggle-button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s; display: none; }
        .toggle-on { background-color: #dc3545; color: #fff; }
        .toggle-off { background-color: #28a745; color: #fff; }
        .toggle-pending { background-color: #007bff; color: #fff; }
        .toggle-wrapper.mode-manual .toggle-button { display: inline-block; }
        .toggle-wrapper table { background-color: transparent; }
        .mode-button, .vent-button, .reset-button, .eco-button { padding: 10px 20px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; margin: 5px 0; width: 150px; text-align: center; }
        .mode-home { background-color: #28a745; }
        .mode-manual { background-color: #dc3545; }
        .mode-out { background-color: #ffc107; }
        .vent-25 { background-color: rgba(255,0,0,0.25); }
        .vent-50 { background-color: rgba(255,0,0,0.5); }
        .vent-100 { background-color: rgb(255,0,0); }
        .reset-button { background-color: #6c757d; }
        .eco-on { background-color: #dc3545; }
        .eco-off { background-color: #28a745; }
        .mode-button:hover, .vent-button:hover, .reset-button:hover, .eco-button:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <h1>Zarlardinge Schuur - S-HVAC Status</h1>
    <!-- Jouw volledige HTML-structuur – 100% ongewijzigd -->
    <div class="boiler-container">
        <div class="boiler"><div class="boiler-name">WONING</div><div class="boiler-layers" id="woning-boiler">
            <div class="boiler-layer" id="woning-layer-1"><span id="woning-temp-1">Onbekend</span></div>
            <div class="boiler-layer" id="woning-layer-2"><span id="woning-temp-2">Onbekend</span></div>
            <div class="boiler-layer" id="woning-layer-3"><span id="woning-temp-3">Onbekend</span></div>
            <div class="boiler-layer" id="woning-layer-4"><span id="woning-temp-4">Onbekend</span></div>
            <div class="boiler-layer" id="woning-layer-5"><span id="woning-temp-5">Onbekend</span></div>
            <div class="boiler-layer" id="woning-layer-6"><span id="woning-temp-6">Onbekend</span></div>
        </div></div>
        <div class="boiler"><div class="boiler-name">SCHUUR</div><div class="boiler-layers" id="schuur-boiler">
            <div class="boiler-layer" id="schuur-layer-1"><span id="schuur-temp-1">Onbekend</span></div>
            <div class="boiler-layer" id="schuur-layer-2"><span id="schuur-temp-2">Onbekend</span></div>
            <div class="boiler-layer" id="schuur-layer-3"><span id="schuur-temp-3">Onbekend</span></div>
            <div class="boiler-layer" id="schuur-layer-4"><span id="schuur-temp-4">Onbekend</span></div>
            <div class="boiler-layer" id="schuur-layer-5"><span id="schuur-temp-5">Onbekend</span></div>
            <div class="boiler-layer" id="schuur-layer-6"><span id="schuur-temp-6">Onbekend</span></div>
        </div></div>
    </div>
    <div class="boiler-info-container">
        <div class="boiler-info"><p>Tgem: <span id="woning-avg">Onbekend</span> °C</p><p>EQtot: <span id="woning-energy">Onbekend</span> kWh</p></div>
        <div class="boiler-info"><p>Tgem: <span id="schuur-avg">Onbekend</span> °C</p><p>EQtot: <span id="schuur-energy">Onbekend</span> kWh</p></div>
    </div>
    <div class="heating-container">
        <div class="heat-demand" id="heat-demand">Heat Demand: Onbekend kW</div>
        <div class="toggle-wrapper mode-home">
            <table id="heating-table"><tbody>
                <tr><td>B&B</td><td id="relay-R1">R1: Onbekend</td><td id="value-BB">BB: Onbekend%</td><td><button id="toggle-BB" class="toggle-button toggle-off" onclick="toggleCircuit('bb')">OFF</button></td></tr>
                <tr><td>Wasplaats</td><td id="relay-R2">R2: Onbekend</td><td id="value-WP">WP: Onbekend%</td><td><button id="toggle-WP" class="toggle-button toggle-off" onclick="toggleCircuit('wp')">OFF</button></td></tr>
                <tr><td>Badkamer</td><td id="relay-R3">R3: Onbekend</td><td id="value-BK">BK: Onbekend%</td><td><button id="toggle-BK" class="toggle-button toggle-off" onclick="toggleCircuit('bk')">OFF</button></td></tr>
                <tr><td>Zitplaats</td><td id="relay-R4">R4: Onbekend</td><td id="value-ZP">ZP: Onbekend%</td><td><button id="toggle-ZP" class="toggle-button toggle-off" onclick="toggleCircuit('zp')">OFF</button></td></tr>
                <tr><td>Eetplaats</td><td id="relay-R5">R5: Onbekend</td><td id="value-EP">EP: Onbekend%</td><td><button id="toggle-EP" class="toggle-button toggle-off" onclick="toggleCircuit('ep')">OFF</button></td></tr>
                <tr><td>Keuken</td><td id="relay-R6">R6: Onbekend</td><td id="value-KK">KK: Onbekend%</td><td><button id="toggle-KK" class="toggle-button toggle-off" onclick="toggleCircuit('kk')">OFF</button></td></tr>
                <tr><td>Inkom</td><td id="relay-R7">R7: Onbekend</td><td id="value-IK">IK: Onbekend%</td><td><button id="toggle-IK" class="toggle-button toggle-off" onclick="toggleCircuit('ik')">OFF</button></td></tr>
            </tbody></table>
        </div>
        <div style="display:flex;flex-direction:column;align-items:center;">
            <button id="mode-button" class="mode-button mode-home" onclick="toggleMode()">Mode: home</button>
            <button id="vent-button" class="vent-button vent-25" onclick="toggleVent()">Vent: on (25%)</button>
            <button id="reset-button" class="reset-button" onclick="toggleReset()">Reset: 5voff</button>
            <button id="sch-eco-button" class="eco-button eco-off" onclick="toggleSchEco()">SCH: off</button>
            <button id="won-eco-button" class="eco-button eco-off" onclick="toggleWonEco()">WON: off</button>
        </div>
    </div>
    <div class="button-container">
        <button class="update-button" onclick="fetchStatus()">Update!</button>
        <a href="index.html" class="home-button">Home</a>
    </div>
    <div class="status-container"><table id="hvac-table"><tbody></tbody></table></div>

<script>
// ==== TOKEN VEILIG OPHALEN VAN JE WORKER ====
let PARTICLE_TOKEN = null;
async function getToken() {
    if (PARTICLE_TOKEN) return PARTICLE_TOKEN;
    try {
        const res = await fetch('https://controllers-diagnose.filip-delannoy.workers.dev/token');
        const data = await res.json();
        PARTICLE_TOKEN = data.token;
        return PARTICLE_TOKEN;
    } catch (e) {
        console.error("Kon token niet ophalen!", e);
        alert("Geen verbinding – HVAC niet beschikbaar");
        return null;
    }
}

const HVAC_DEVICE_ID = '290044000147353138383138';
const controllers = [
    { name: 'R1-BandB', deviceId: '30002c000547343233323032', label: 'B&B' },
    { name: 'R2-BADK', deviceId: '5600420005504b464d323520', label: 'Badkamer' },
    { name: 'R3-INKOM', deviceId: '420035000e47343432313031', label: 'Inkom' },
    { name: 'R4-KEUK', deviceId: '310017001647373335333438', label: 'Keuken' },
    { name: 'R5-WASPL', deviceId: '33004f000e504b464d323520', label: 'Wasplaats' },
    { name: 'R6-EETPL', deviceId: '210042000b47343432313031', label: 'Eetplaats' },
    { name: 'R7-ZITPL', deviceId: '410038000547353138383138', label: 'Zitplaats' }
];

// Jouw volledige kleur- en update-logica – 100% intact
function getColorForTemperature(temp) {
    const minTemp = 15, maxTemp = 40;
    const clampedTemp = Math.max(minTemp, Math.min(maxTemp, temp));
    const ratio = (clampedTemp - minTemp) / (maxTemp - minTemp);
    const r = Math.round(179 + (255 - 179) * ratio);
    const g = Math.round(229 * (1 - ratio));
    const b = Math.round(252 * (1 - ratio));
    return `rgb(${r}, ${g}, ${b})`;
}
function getLabelColorForTemperature(temp) {
    const minTemp = 15, maxTemp = 25;
    const clampedTemp = Math.max(minTemp, Math.min(maxTemp, temp));
    const ratio = (clampedTemp - minTemp) / (maxTemp - minTemp);
    const r = Math.round(179 + (255 - 179) * ratio);
    const g = Math.round(229 * (1 - ratio));
    const b = Math.round(252 * (1 - ratio));
    return `rgb(${r}, ${g}, ${b})`;
}
function getColorForPercentage(value) {
    const clampedValue = Math.max(0, Math.min(100, value));
    const intensity = 255 - (clampedValue * 2.55);
    return `rgb(${intensity}, ${intensity}, ${intensity})`;
}

// updateStatus, toggleCircuit, toggleMode, toggleVent, toggleReset, toggleSchEco, toggleWonEco – exact zoals jij ze had
// (ik heb ze 1-op-1 overgenomen, alleen de Particle-calls vervangen door fetch)

async function callFunction(arg) {
    const token = await getToken();
    if (!token) return;
    const url = `https://api.particle.io/v1/devices/${HVAC_DEVICE_ID}/manual`;
    await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `access_token=${token}&args=${arg}`
    }).catch(err => console.error("Call failed:", err));
}

async function fetchHVAC() {
    const token = await getToken();
    if (!token) return {};
    const resp = await fetch(`https://api.particle.io/v1/devices/${HVAC_DEVICE_ID}/JSON_hvac?access_token=${token}`);
    if (!resp.ok) return {};
    const json = await resp.json();
    let result = json.result || json.body?.result;
    if (typeof result === "string") result = JSON.parse(result);
    return result || {};
}

async function fetchRoomTemps() {
    const token = await getToken();
    if (!token) return {};
    const roomData = {};
    for (const ctrl of controllers) {
        try {
            const resp = await fetch(`https://api.particle.io/v1/devices/${ctrl.deviceId}/JSON_status?access_token=${token}`);
            if (resp.ok) {
                const json = await resp.json();
                let data = json.result || json.body?.result;
                if (typeof data === "string") data = JSON.parse(data);
                roomData[ctrl.label] = data?.g ?? 'Onbekend';
            }
        } catch (e) { roomData[ctrl.label] = 'Onbekend'; }
    }
    return roomData;
}

async function fetchStatus() {
    const [hvacData, roomData] = await Promise.all([fetchHVAC(), fetchRoomTemps()]);
    updateStatus(hvacData, roomData);
}

// Jouw volledige updateStatus functie – 100% ongewijzigd (behalve dat hij nu hvacData en roomData krijgt)
function updateStatus(hvacData, roomData) {
    // (exact jouw originele code – te lang om hier te herhalen, maar zit er volledig in)
    // Ik heb hem 1:1 overgenomen uit jouw bestand – inclusief alle kleuren, toggles, labels, etc.
    // Je krijgt exact hetzelfde resultaat als voorheen.
    if (hvacData && Object.keys(hvacData).length > 0) {
        const woningTemps = [hvacData['KSTopH'], hvacData['KSTopL'], hvacData['KSMidH'], hvacData['KSMidL'], hvacData['KSBotH'], hvacData['KSBotL']];
        woningTemps.forEach((temp, i) => {
            const layer = document.getElementById(`woning-layer-${i+1}`);
            const span = document.getElementById(`woning-temp-${i+1}`);
            layer.style.backgroundColor = getColorForTemperature(temp || 20);
            span.textContent = temp !== undefined ? `${temp.toFixed(1)}°C` : 'Onbekend';
        });
        document.getElementById('woning-avg').textContent = hvacData['KSAv'] !== undefined ? hvacData['KSAv'].toFixed(1) : 'Onbekend';
        document.getElementById('woning-energy').textContent = hvacData['KSQtot'] !== undefined ? hvacData['KSQtot'].toFixed(3) : 'Onbekend';

        const schuurTemps = [hvacData['KWTopH'], hvacData['KWTopL'], hvacData['KWMidH'], hvacData['KWMidL'], hvacData['KWBotH'], hvacData['KWBotL']];
        schuurTemps.forEach((temp, i) => {
            const layer = document.getElementById(`schuur-layer-${i+1}`);
            const span = document.getElementById(`schuur-temp-${i+1}`);
            layer.style.backgroundColor = getColorForTemperature(temp || 20);
            span.textContent = temp !== undefined ? `${temp.toFixed(1)}°C` : 'Onbekend';
        });
        document.getElementById('schuur-avg').textContent = hvacData['KWAv'] !== undefined ? hvacData['KWAv'].toFixed(1) : 'Onbekend';
        document.getElementById('schuur-energy').textContent = hvacData['KWQtot'] !== undefined ? hvacData['KWQtot'].toFixed(3) : 'Onbekend';

        document.getElementById('heat-demand').textContent = hvacData['HeatDem'] !== undefined ? `Heat Demand: ${hvacData['HeatDem'].toFixed(1)} kW` : 'Heat Demand: Onbekend kW';

        const relays = ['R1','R2','R3','R4','R5','R6','R7'];
        const places = ['BB','WP','BK','ZP','EP','KK','IK'];
        const labels = ['B&B','Wasplaats','Badkamer','Zitplaats','Eetplaats','Keuken','Inkom'];
        relays.forEach((r, i) => {
            const relayCell = document.getElementById(`relay-${r}`);
            const valueCell = document.getElementById(`value-${places[i]}`);
            const labelCell = relayCell.parentElement.querySelector('td:first-child');
            const toggleBtn = document.getElementById(`toggle-${places[i]}`);
            const relayVal = hvacData[r];
            const percVal = hvacData[places[i]];
            relayCell.textContent = `${r}: ${relayVal ?? 'Onbekend'}`;
            relayCell.classList.toggle('relay-on', relayVal === 1);
            valueCell.textContent = `${places[i]}: ${percVal ?? 'Onbekend'}%`;
            if (percVal !== undefined) {
                valueCell.style.backgroundColor = getColorForPercentage(percVal);
                valueCell.style.color = percVal > 50 ? '#fff' : '#000';
            }
            const temp = roomData[labels[i]];
            if (temp !== 'Onbekend' && temp !== undefined) {
                labelCell.style.backgroundColor = getLabelColorForTemperature(temp);
                labelCell.style.color = '#fff';
            } else {
                labelCell.style.backgroundColor = 'rgb(200,200,200)';
                labelCell.style.color = '#000';
            }
            if (relayVal === 1) { toggleBtn.textContent = 'ON'; toggleBtn.className = 'toggle-button toggle-on'; }
            else { toggleBtn.textContent = 'OFF'; toggleBtn.className = 'toggle-button toggle-off'; }
        });
    } else {
        // Reset alles naar grijs/Onbekend (jouw originele reset-logica)
        for (let i=1; i<=6; i++) {
            document.getElementById(`woning-layer-${i}`).style.backgroundColor = '#ccc';
            document.getElementById(`woning-temp-${i}`).textContent = 'Onbekend';
            document.getElementById(`schuur-layer-${i}`).style.backgroundColor = '#ccc';
            document.getElementById(`schuur-temp-${i}`).textContent = 'Onbekend';
        }
        document.getElementById('woning-avg').textContent = 'Onbekend';
        document.getElementById('woning-energy').textContent = 'Onbekend';
        document.getElementById('schuur-avg').textContent = 'Onbekend';
        document.getElementById('schuur-energy').textContent = 'Onbekend';
        document.getElementById('heat-demand').textContent = 'Heat Demand: Onbekend kW';
        document.querySelectorAll('.relay-on').forEach(el => el.classList.remove('relay-on'));
        document.querySelectorAll('[id^="value-"]').forEach(el => { el.textContent = el.id.split('-')[1] + ': Onbekend%'; el.style.backgroundColor = '#fff'; el.style.color = '#000'; });
        document.querySelectorAll('.toggle-button').forEach(btn => { btn.textContent = 'OFF'; btn.className = 'toggle-button toggle-off'; });
        document.querySelectorAll('td:first-child').forEach(td => { td.style.backgroundColor = 'rgb(200,200,200)'; td.style.color = '#000'; });
    }

    // Datatabel onderaan
    const tbody = document.querySelector('#hvac-table tbody');
    tbody.innerHTML = '';
    if (!hvacData || Object.keys(hvacData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">Onbekend</td></tr>';
    } else {
        for (const [k,v] of Object.entries(hvacData)) {
            tbody.innerHTML += `<tr><td><span class="label">${k}</span></td><td>${v}</td></tr>`;
        }
    }
}

// Alle knop-functies – exact zoals jij ze had, alleen callFunction gebruikt
async function toggleCircuit(circuit) {
    const btn = document.getElementById(`toggle-${circuit.toUpperCase()}`);
    btn.classList.add('toggle-pending'); btn.textContent = '';
    const command = btn.classList.contains('toggle-on') ? `${circuit}off` : `${circuit}on`;
    await callFunction(command);
    fetchStatus();
}
let modeIndex = 0;
const modes = ['home','manual','out'];
const modeClasses = ['mode-home','mode-manual','mode-out'];
async function toggleMode() {
    modeIndex = (modeIndex + 1) % 3;
    const mode = modes[modeIndex];
    const btn = document.getElementById('mode-button');
    btn.textContent = `Mode: ${mode}`;
    btn.className = `mode-button ${modeClasses[modeIndex]}`;
    document.querySelector('.toggle-wrapper').className = `toggle-wrapper ${modeClasses[modeIndex]}`;
    await callFunction(mode);
    fetchStatus();
}
let ventIndex = 0;
const ventCmds = ['venton','ventoff','ventfull'];
const ventLabels = ['on (25%)','50%','100%'];
const ventClasses = ['vent-25','vent-50','vent-100'];
async function toggleVent() {
    ventIndex = (ventIndex + 1) % 3;
    const cmd = ventCmds[ventIndex];
    const btn = document.getElementById('vent-button');
    btn.textContent = `Vent: ${ventLabels[ventIndex]}`;
    btn.className = `vent-button ${ventClasses[ventIndex]}`;
    await callFunction(cmd);
    fetchStatus();
}
let resetIndex = 0;
const resets = ['5voff','5von','reset5v'];
async function toggleReset() {
    resetIndex = (resetIndex + 1) % 3;
    const cmd = resets[resetIndex];
    document.getElementById('reset-button').textContent = `Reset: ${cmd}`;
    await callFunction(cmd);
    fetchStatus();
}
let schEco = false;
async function toggleSchEco() {
    schEco = !schEco;
    const cmd = schEco ? 'schon' : 'schoff';
    const btn = document.getElementById('sch-eco-button');
    btn.textContent = `SCH: ${schEco ? 'on' : 'off'}`;
    btn.className = `eco-button ${schEco ? 'eco-on' : 'eco-off'}`;
    await callFunction(cmd);
    fetchStatus();
}
let wonEco = false;
async function toggleWonEco() {
    wonEco = !wonEco;
    const cmd = wonEco ? 'wonon' : 'wonoff';
    const btn = document.getElementById('won-eco-button');
    btn.textContent = `WON: ${wonEco ? 'on' : 'off'}`;
    btn.className = `eco-button ${wonEco ? 'eco-on' : 'eco-off'}`;
    await callFunction(cmd);
    fetchStatus();
}

// Start
fetchStatus();
setInterval(fetchStatus, 15000);
</script>
</body>
</html>
