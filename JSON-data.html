<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zarlardinge - Compact Kamer Status (Gecorrigeerd)</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:url('BG.jpg') center/cover no-repeat;color:#222}
  .title{font-size:20px;font-weight:700;text-align:center;padding:18px;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,.6)}
  .buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:10px}
  .btn{padding:10px 16px;background:#007bff;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .esp-btn{padding:10px 16px;background:#28a745;color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer} /* Groen voor ESP32 */
  .esp-btn:active{transform:translateY(1px)}
  #box{max-width:520px;margin:18px auto;padding:18px;background:rgba(255,255,255,0.95);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.18)}
  .row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.04);font-size:14px}
  .lbl{font-weight:700;color:#1a5276;flex:0 0 130px}
  .val{font-family:monospace;font-weight:700;padding:6px 10px;border-radius:6px;min-width:86px;text-align:center}
  .loading{text-align:center;padding:40px;color:#666}
  .home{display:block;width:120px;margin:18px auto;padding:10px;background:#28a745;color:#fff;text-align:center;border-radius:8px;text-decoration:none}
  @media (max-width:520px){.lbl{flex:0 0 100px}.val{min-width:64px;font-size:13px}}
</style>
</head>
<body>
  <div class="title">Zarlardinge - Room Status</div>
  <div class="buttons">
    <button class="btn" onclick="go('30002c000547343233323032','BandB')">BandB</button>
    <button class="btn" onclick="go('5600420005504b464d323520','Badkamer')">Badkamer</button>
    <button class="btn" onclick="go('420035000e47343432313031','Inkom')">Inkom</button>
    <button class="btn" onclick="go('310017001647373335333438','Keuken')">Keuken</button>
    <button class="btn" onclick="go('33004f000e504b464d323520','Wasplaats')">Wasplaats</button>
    <button class="btn" onclick="go('210042000b47343432313031','Eetplaats')">Eetplaats</button>
    <button class="btn" onclick="go('410038000547353138383138','Zitplaats')">Zitplaats</button>
    <button class="btn" onclick="go('200033000547373336323230','TESTROOM')">TESTROOM (Photon)</button>
    
    <!-- NIEUWE KNOP: Testroom ESP32 – haalt JSON van lokale ESP32 -->
    <button class="esp-btn" onclick="goESP32()">Testroom ESP32</button>
  </div>
  <div id="box"><div class="loading">Kies een kamer</div></div>
  <a class="home" href="index.html">Home</a>

<script>
// ==== TOKEN VEILIG OPHALEN (voor Particle) ====
let PARTICLE_TOKEN = null;
async function getToken() {
    if (PARTICLE_TOKEN) return PARTICLE_TOKEN;
    try {
        const res = await fetch('https://controllers-diagnose.filip-delannoy.workers.dev/token');
        const data = await res.json();
        PARTICLE_TOKEN = data.token;
        return PARTICLE_TOKEN;
    } catch (e) {
        console.error("Kon token niet ophalen!", e);
        return null;
    }
}

// ==== BESTAANDE go() voor Particle devices (ongewijzigd) ====
async function go(deviceId, displayName){
  const box = document.getElementById('box');
  box.innerHTML = `<div class="loading">Laden ${displayName}…</div>`;
 
  const token = await getToken();
  if (!token) {
    box.innerHTML = `<div class="loading">⚠️ Geen toegang tot Particle-token</div>`;
    return;
  }
  try {
    const resp = await fetch(`https://api.particle.io/v1/devices/${deviceId}/JSON_status?access_token=${token}`, {cache:'no-store'});
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const d = await resp.json();
    const parsed = safeParseResult(d.result ?? d.body?.result ?? null);
    if (!parsed) throw new Error('Kan JSON-status niet parsen');
    updateBoxWithData(box, displayName, parsed);
  } catch(err){
    console.error('Fout bij ophalen:', err);
    box.innerHTML = `<div class="loading">Fout bij laden: ${err.message}</div>`;
  }
}

// ==== NIEUWE FUNCTIE: goESP32() voor lokale ESP32 ====
async function goESP32() {
  const box = document.getElementById('box');
  box.innerHTML = `<div class="loading">Laden Testroom ESP32…</div>`;

  try {
    const resp = await fetch('http://192.168.1.36/status.json', {cache: 'no-store'});
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();

    // Jouw ESP32 JSON heeft exact dezelfde keys (a t/m x + det + up)
    // Dus we kunnen dezelfde updateBoxWithData gebruiken!
    updateBoxWithData(box, "Testroom ESP32", data);

  } catch (err) {
    console.error('Fout bij ophalen ESP32:', err);
    box.innerHTML = `<div class="loading">Fout: ${err.message}<br>Ben je op het thuisnetwerk?</div>`;
  }
}

// ==== REST VAN JE ORIGINELE SCRIPT (volledig ongewijzigd) ====
const order = ["Strength","Quality","FreeMem","Temp1","Temp2","Humi","Dew","DewAlert","Light","Dust","CO2","TSTATon","MOV1","MOV1light","MOV2","MOV2light","BEAMalert","BEAMlight","SUNLight","Night","Bed","R","G","B"];
const keyOf = {
  Strength: "v", Quality: "w", FreeMem: "x", Temp1: "g", Temp2: "h",
  Humi: "d", Dew: "c", DewAlert: "k", Light: "e", Dust: "b", CO2: "a",
  TSTATon: "l", MOV1: "i", MOV1light: "m", MOV2: "j", MOV2light: "n",
  BEAMalert: "o", BEAMlight: "p", SUNLight: "f", Night: "q", Bed: "r",
  R: "s", G: "t", B: "u"
};
// (rules, cmap, interpolateColor, colorFor, safeParseResult blijven 100% identiek – kopieer ze uit jouw originele code)

function updateBoxWithData(boxElement, displayName, s){
  const temp1 = (s && s['g'] !== undefined) ? s['g'] : 'Onbekend';
  let html = `<h2 style="text-align:center;color:#1a5276;margin-bottom:12px">${displayName} - Compact Status</h2>`;
  order.forEach(label=>{
    const key = keyOf[label];
    let v = (s && s[key] !== undefined) ? s[key] : 'Onbekend';
    if (typeof v === 'object') { try { v = JSON.stringify(v); } catch(e){ v = 'Onbekend'; } }
    const c = colorFor(v, label, temp1);
    html += `<div class="row"><span class="lbl">${label}:</span><span class="val" style="background:${c.bg};color:${c.txt}">${v}</span></div>`;
  });
  boxElement.innerHTML = html;
}
</script>
</body>
</html>
