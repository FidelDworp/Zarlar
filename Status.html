<!DOCTYPE html>
<html>
<head>
    <title>Zarlardinge - Live Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    body {
        background-image: url("BG.jpg");
        background-size: cover;
        background-repeat: no-repeat;
        font-family: Arial, sans-serif;
        color: #333;
        margin: 20px;
    }
    .title {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 20px;
        color: #333;
    }
    .section-container {
        background-color: rgba(128, 128, 128, 0.5);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        max-height: 300px;
        overflow-y: auto;
    }
    h1 {
        font-size: 18px;
        font-family: Arial, sans-serif;
        color: #333;
    }
    .event {
        background: rgba(255,255,255,0.8);
        color: #333;
        padding: 6px 10px;
        margin: 4px 0;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        word-break: break-all;
    }
    .time { color: #666; margin-right: 8px; }
    .eventname { color: #007bff; font-weight: bold; }
    .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
        margin-bottom: 20px;
    }
    .home-button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        text-align: center;
    }
    .home-button:hover {
        background-color: #0056b3;
    }
    .status-indicator {
        text-align: center;
        margin: 10px 0;
        padding: 10px;
        background: rgba(0,255,0,0.2);
        color: #333;
        border-radius: 5px;
        font-weight: bold;
    }
    </style>
</head>
<body>
    <div class="title">Zarlardinge - Live Status Monitor</div>

    <div class="section-container">
        <h1>Zitplaats</h1>
        <div id="zitplaats"></div>
    </div>
    <div class="section-container">
        <h1>BandB</h1>
        <div id="bandb"></div>
    </div>
    <div class="section-container">
        <h1>Badkamer</h1>
        <div id="badkamer"></div>
    </div>
    <div class="section-container">
        <h1>Inkom</h1>
        <div id="inkom"></div>
    </div>
    <div class="section-container">
        <h1>Keuken</h1>
        <div id="keuken"></div>
    </div>
    <div class="section-container">
        <h1>Wasplaats</h1>
        <div id="wasplaats"></div>
    </div>
    <div class="section-container">
        <h1>Eetplaats / Slaapkamer</h1>
        <div id="eetplaats"></div>
    </div>
    <div class="section-container">
        <h1>Buitenverlichting</h1>
        <div id="buiten"></div>
    </div>
    <div class="section-container">
        <h1>Sunlight</h1>
        <div id="sunlight"></div>
    </div>
    <div class="section-container">
        <h1>HVAC</h1>
        <div id="hvac"></div>
    </div>
    <div class="section-container">
        <h1>ECO Solar</h1>
        <div id="solar"></div>
    </div>

    <div class="button-container">
        <a href="index.html" class="home-button">Home</a>
    </div>

    <div id="status-indicator" class="status-indicator" style="display:none;">Verbonden: Polling actief (elke 5 sec)</div>

    <script>
    const token = 'ba9d9e1ed9f70cc5db24de2db21764a3a3afe28b';
    const deviceMap = {
        '410038000547353138383138': 'zitplaats',
        '30002c000547343233323032': 'bandb',
        '5600420005504b464d323520': 'badkamer',
        '420035000e47343432313031': 'inkom',
        '310017001647373335333438': 'keuken',
        '33004f000e504b464d323520': 'wasplaats',
        '210042000b47343432313031': 'eetplaats',
        '2d0032001247333438353733': 'buiten',
        '390028001147343339383037': 'sunlight',
        '3e003f001447343338333633': 'hvac',
        '310049000f47343432313031': 'solar'
    };

    // Toon indicator dat script draait
    document.getElementById('status-indicator').style.display = 'block';

    // Polling-functie: haalt recente events op (limit 50 voor recente data)
    async function fetchEvents() {
        try {
            const response = await fetch(`https://api.particle.io/v1/events?access_token=${token}&limit=50`);
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const events = await response.json();
            events.forEach(eventData => {
                if (eventData.coreid) {
                    const zoneId = deviceMap[eventData.coreid] || 'onbekend';
                    const div = document.getElementById(zoneId);
                    if (!div || !eventData.name) return;

                    // Voorkom duplicaten: check of dit event al bestaat (simpel op naam + data)
                    const existing = Array.from(div.children).find(child => 
                        child.innerHTML.includes(eventData.name) && child.innerHTML.includes(eventData.data || '')
                    );
                    if (existing) return;  // Skip duplicaat

                    const now = new Date().toLocaleTimeString('nl-BE', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
                    const line = document.createElement('div');
                    line.className = 'event';
                    line.innerHTML = `<span class="time">${now}</span><span class="eventname">${eventData.name}</span>: ${eventData.data || ''}`;
                    div.insertBefore(line, div.firstChild);
                    // Max 20 regels per zone
                    while (div.children.length > 20) div.removeChild(div.lastChild);
                }
            });
        } catch (err) {
            console.error('Polling fout:', err);  // Alleen in console, geen blokkerende melding
        }
    }

    // Start polling
    fetchEvents();  // Eerste keer meteen
    setInterval(fetchEvents, 5000);  // Elke 5 sec
    </script>
</body>
</html>
