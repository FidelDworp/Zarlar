<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Zarlardinge Schuur ‚Äî Controllers Diagnose</title>
<style>
  /* Huisstijl / layout */
  :root{
    --card-bg: rgba(255,255,255,0.88);
    --accent: #007bff;
    --muted: #666;
  }
  html,body{height:100%; margin:0; font-family: Arial, Helvetica, sans-serif; color:#222;}
  body{
    background-image:url("BG.jpg");
    background-size:cover;
    background-position:center center;
    padding:18px;
    -webkit-font-smoothing:antialiased;
  }

  h1{font-size:18px; margin:0 0 10px 0; color:#111;}
  .container{max-width:720px; margin:0 auto;}

  .card{
    background:var(--card-bg);
    border-radius:10px;
    padding:12px;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
    margin-bottom:12px;
  }

  .legend{font-size:13px; color:var(--muted); display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
  .legend .item{display:inline-flex; align-items:center; gap:6px;}
  .dot, .rssi-dot { width:12px; height:12px; border-radius:50%; display:inline-block; }

  .group-title{font-weight:700; margin:8px 0 6px 0; font-size:14px;}
  .table{width:100%; border-collapse:collapse; font-size:14px;}
  .row{display:flex; align-items:center; justify-content:space-between; padding:8px 6px; border-bottom:1px solid rgba(0,0,0,0.06);}
  .row:last-child{border-bottom:none;}
  .left{display:flex; align-items:center; gap:10px; min-width:180px; flex:1;}
  .name{font-weight:600;}
  .console-btn{background:var(--accent); color:white; padding:6px 10px; border-radius:6px; text-decoration:none; font-size:13px;}
  .diag{display:flex; gap:10px; align-items:center; font-size:13px; color:#222; min-width:260px; justify-content:flex-end;}

  .rssi-value{font-size:12px; color:#222; margin-left:4px;}
  .small-muted{font-size:12px; color:var(--muted);}

  /* mobile adjustments */
  @media (max-width:520px){
    .diag{min-width:140px; gap:8px; font-size:12px;}
    .left{min-width:120px}
    .console-btn{padding:5px 8px; font-size:12px}
  }
  /* error box */
  .error{
    background:#ffe8e8; color:#7a0b0b; border-radius:8px; padding:8px; margin-bottom:12px; font-size:13px;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üìü Zarlardinge Schuur ‚Äî Controllers Diagnose</h1>

    <div id="errorBox" style="display:none" class="error"></div>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <div class="small-muted">Deze pagina toont alle Photons met directe links naar de Particle Console en diagnostic-waarden.</div>
          <div class="legend" style="margin-top:6px">
            <div class="item"><span class="dot" style="background:green;"></span>Online</div>
            <div class="item"><span class="dot" style="background:orange;"></span>Offline &lt;15 min</div>
            <div class="item"><span class="dot" style="background:red;"></span>Offline ‚â•15 min</div>
            <div class="item"><span class="rssi-dot" style="background:green;"></span>Wi-Fi sterk</div>
            <div class="item"><span class="rssi-dot" style="background:orange;"></span>Wi-Fi matig</div>
            <div class="item"><span class="rssi-dot" style="background:red;"></span>Wi-Fi zwak</div>
          </div>
        </div>
        <div style="text-align:right; font-size:12px; color:var(--muted); max-width:260px">
          <div>Deze pagina gebruikt een Cloudflare Worker (<a href="https://controllers-diagnose.filip-delannoy.workers.dev/" target="_blank">controllers-diagnose.filip-delannoy.workers.dev</a>)</div>
          <div style="margin-top:6px">Je Particle-token blijft veilig op de Worker ‚Äî niet in deze pagina.</div>
        </div>
      </div>
    </div>

    <!-- Rooms group -->
    <div class="card">
      <div class="group-title">Rooms</div>
      <div id="roomsList"></div>
    </div>

    <!-- Systems group -->
    <div class="card">
      <div class="group-title">System Sensors</div>
      <div id="systemsList"></div>
    </div>
  </div>

<script>
/*
  Definitieve pagina code:
  - Fetches your worker JSON
  - Expects array of devices with fields:
    id,name,status ('online'|'offline'), last_seen (ISO), last_seen_minutes (number), firmware, rssi (number or '--')
  - Renders Rooms (8) then Systems (3)
*/

const WORKER_URL = 'https://controllers-diagnose.filip-delannoy.workers.dev/';

// device order (rooms first, then systems)
const ROOM_IDS = [
  "30002c000547343233323032",
  "5600420005504b464d323520",
  "420035000e47343432313031",
  "310017001647373335333438",
  "33004f000e504b464d323520",
  "210042000b47343432313031",
  "410038000547353138383138",
  "2d0032001247333438353733"
];
const SYSTEM_IDS = [
  "390028001147343339383037",
  "310049000f47343432313031",
  "290044000147353138383138"
];

const errorBox = document.getElementById('errorBox');

function rssiColor(rssi){
  if(rssi === null || rssi === undefined || rssi === '--') return 'gray';
  // rssi in dBm: higher (less negative) is better
  if(Number(rssi) >= -60) return 'green';
  if(Number(rssi) >= -75) return 'orange';
  return 'red';
}

function createRow(device){
  // left area: name + console button
  const row = document.createElement('div');
  row.className = 'row';

  const left = document.createElement('div');
  left.className = 'left';

  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = device.name || device.id;

  left.appendChild(name);

  // console link
  const consoleBtn = document.createElement('a');
  consoleBtn.className = 'console-btn';
  consoleBtn.href = `https://console.particle.io/devices/${device.id}`;
  consoleBtn.target = '_blank';
  consoleBtn.textContent = 'Console';

  // diagnosis area
  const diag = document.createElement('div');
  diag.className = 'diag';

  // status dot
  const statusDot = document.createElement('span');
  statusDot.className = 'dot';
  // choose color: online green; offline but last_seen_minutes<15 orange; else red
  const minutes = (typeof device.last_seen_minutes === 'number') ? device.last_seen_minutes : (device.last_seen ? ((Date.now() - new Date(device.last_seen))/60000) : 99999);
  if(device.status === 'online') statusDot.style.background = 'green';
  else if(minutes < 15) statusDot.style.background = 'orange';
  else statusDot.style.background = 'red';
  statusDot.title = `Status: ${device.status}\nLaatst gezien: ${device.last_seen || '--'}`;

  // rssi dot + value
  const rssiDot = document.createElement('span');
  rssiDot.className = 'rssi-dot';
  rssiDot.style.background = rssiColor(device.rssi);
  rssiDot.title = (device.rssi && device.rssi !== '--') ? `RSSI: ${device.rssi} dBm` : 'RSSI: --';

  const rssiVal = document.createElement('span');
  rssiVal.className = 'rssi-value';
  rssiVal.textContent = (device.rssi && device.rssi !== '--') ? `${device.rssi} dBm` : '--';

  // last seen formatted
  const last = document.createElement('span');
  last.className = 'small-muted';
  last.textContent = device.last_seen ? (new Date(device.last_seen)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';

  // firmware
  const fw = document.createElement('span');
  fw.className = 'small-muted';
  fw.textContent = device.firmware && device.firmware !== '--' ? `fw: ${device.firmware}` : 'fw: --';

  // build diag
  diag.appendChild(statusDot);
  diag.appendChild(rssiDot);
  diag.appendChild(rssiVal);
  diag.appendChild(last);
  diag.appendChild(fw);

  row.appendChild(left);
  row.appendChild(consoleBtn);
  row.appendChild(diag);

  return row;
}

async function refreshAll(){
  errorBox.style.display = 'none';
  try{
    const res = await fetch(WORKER_URL, {cache: 'no-store'});
    if(!res.ok) throw new Error(`Worker HTTP ${res.status}`);
    const json = await res.json();

    // map by id for quick lookup
    const map = {};
    json.forEach(d => { map[d.id] = d; });

    // fill rooms
    const roomsEl = document.getElementById('roomsList');
    roomsEl.innerHTML = '';
    ROOM_IDS.forEach(id => {
      const dev = map[id] || { id, name:id, status:'offline', last_seen:null, last_seen_minutes:99999, firmware:'--', rssi:'--' };
      roomsEl.appendChild(createRow(dev));
    });

    // fill systems
    const sysEl = document.getElementById('systemsList');
    sysEl.innerHTML = '';
    SYSTEM_IDS.forEach(id => {
      const dev = map[id] || { id, name:id, status:'offline', last_seen:null, last_seen_minutes:99999, firmware:'--', rssi:'--' };
      sysEl.appendChild(createRow(dev));
    });

  } catch(err){
    console.error('Fetch error', err);
    errorBox.style.display = 'block';
    errorBox.textContent = '‚ö†Ô∏è Fout bij ophalen van diagnose. Controleer de Cloudflare Worker en open de browser-console (F12) voor details.';
    // keep previous content if any
  }
}

// first load + interval
refreshAll();
setInterval(refreshAll, 30000);
</script>
</body>
</html>
