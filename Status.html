<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Zarlardinge Schuur - Controllers Diagnose</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 20px;
        }
        h1 { font-size: 20px; margin-bottom: 10px; }
        .explanation {
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .legend span { margin-right: 15px; display: inline-flex; align-items: center; }
        .dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .controller-container {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .controller-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .controller-name { flex: 1; font-weight: bold; }
        .console-button {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
        }
        .status-dot {
            width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
    </style>
</head>
<body>
<h1>Zarlardinge Schuur - Controllers Diagnose</h1>

<div class="explanation">
    Deze pagina toont alle Photons van het huis met directe toegang tot de Particle Console en diagnose-informatie, inclusief wifi-signaalsterkte.<br>
    <div class="legend">
        <span><span class="dot" style="background-color:green"></span>Online</span>
        <span><span class="dot" style="background-color:orange"></span>Offline &lt; 15 min</span>
        <span><span class="dot" style="background-color:red"></span>Offline ‚â• 15 min</span>
        <span>üì∂ Wifi (RSSI)</span>
        <span>üïë Laatst gezien</span>
        <span>‚ÑπÔ∏è Firmware versie</span>
    </div>
    <small>Deze pagina gebruikt een Cloudflare Worker service (<a href="https://controllers-diagnose.filip-delannoy.workers.dev/" target="_blank">link</a>) om de diagnose-informatie van de Photon controllers op te halen. Je Particle login is veilig en wordt niet blootgesteld.</small>
</div>

<div id="controllers" class="controller-container"></div>

<script>
const WORKER_URL = "https://controllers-diagnose.filip-delannoy.workers.dev/";

async function loadControllers() {
    const container = document.getElementById('controllers');
    container.innerHTML = 'Laden...';
    try {
        const res = await fetch(WORKER_URL);
        const data = await res.json();
        container.innerHTML = '';
        data.forEach(device => {
            const row = document.createElement('div');
            row.className = 'controller-row';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'controller-name';
            nameDiv.textContent = device.name;

            const consoleButton = document.createElement('a');
            consoleButton.className = 'console-button';
            consoleButton.href = `https://console.particle.io/devices/${device.id}`;
            consoleButton.target = '_blank';
            consoleButton.textContent = 'Console';

            const diagnosis = document.createElement('div');
            diagnosis.style.display = 'flex';
            diagnosis.style.gap = '10px';
            diagnosis.style.alignItems = 'center';

            const dot = document.createElement('span');
            dot.className = 'status-dot';
            if(device.status === 'online') dot.style.backgroundColor = 'green';
            else if(device.status === 'offline' && device.last_seen_minutes < 15) dot.style.backgroundColor = 'orange';
            else dot.style.backgroundColor = 'red';

            const lastSeen = document.createElement('span');
            lastSeen.textContent = device.last_seen ? new Date(device.last_seen).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '--';

            const fw = document.createElement('span');
            fw.textContent = 'fw: ' + (device.firmware || '--');

            const rssi = document.createElement('span');
            rssi.textContent = 'üì∂ ' + (device.rssi || '--');

            diagnosis.appendChild(dot);
            diagnosis.appendChild(rssi);
            diagnosis.appendChild(lastSeen);
            diagnosis.appendChild(fw);

            row.appendChild(nameDiv);
            row.appendChild(consoleButton);
            row.appendChild(diagnosis);
            container.appendChild(row);
        });
    } catch(e) {
        container.innerHTML = 'Fout bij ophalen van de diagnose. Controleer de Cloudflare Worker.';
        console.error(e);
    }
}

// Eerste keer laden
loadControllers();
// Refresh elke 30 seconden
setInterval(loadControllers, 30000);
</script>
</body>
</html>
