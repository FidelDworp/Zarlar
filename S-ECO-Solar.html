<!DOCTYPE html>
<html>
<head>
    <title>Zarlardinge Schuur - S-ECO-solar Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            background-image: url("BG.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            color: #333;
            margin: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { font-size: 18px; margin-bottom: 20px; text-align: center; }
        .boiler-container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .energy-label { font-size: 18px; font-weight: bold; margin-top: 10px; text-align: center; }
        .temp-label { font-size: 16px; margin-top: 5px; text-align: center; }
        canvas { margin-bottom: 10px; }
        .graph-container { margin-top: 15px; }
        .status-container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            width: 100%;
            margin-bottom: 20px;
        }
        .status-item { margin: 5px 0; font-size: 14px; }
        .label { font-weight: bold; margin-right: 5px; }
        .button-container { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
        .update-button, .home-button {
            padding: 10px 20px; background-color: #007bff; color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 14px; text-decoration: none; text-align: center;
        }
        .update-button:hover, .home-button:hover { background-color: #0056b3; }
        .status-messages {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            width: 100%;
            margin-top: 15px;
        }
        .status-messages h2 { font-size: 16px; margin-bottom: 10px; text-align: center; }
        .status-messages ul { list-style-type: none; padding: 0; max-height: 150px; overflow-y: auto; }
        .status-messages li { margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Zarlardinge Schuur - S-ECO-solar Status</h1>
    <div class="boiler-container" id="boiler-container">
        <canvas id="sunCanvas" width="100" height="100"></canvas>
        <div class="temp-label" id="solar-label">Solar = <span id="status-Solar-display">Onbekend</span>°C</div>
        <canvas id="pumpCanvas" width="100" height="100"></canvas>
        <div class="temp-label" id="pwm-label">PWM = <span id="status-pwmVal-display">Onbekend</span></div>
        <canvas id="boilerCanvas" width="150" height="300"></canvas>
        <div class="temp-label" id="tgem-label">Tgem = <span id="status-Tgem">Onbekend</span>°C</div>
        <div class="energy-label" id="energy-label">EQtot = <span id="status-EQtot">Onbekend</span> kWh</div>
        <div class="graph-container">
            <canvas id="graphCanvas" width="300" height="150"></canvas>
            <div class="status-messages" id="status-messages">
                <h2>Laatste statusberichten</h2>
                <ul id="message-list"></ul>
            </div>
        </div>
        <div class="button-container">
            <button class="update-button" onclick="fetchStatus()">Update!</button>
            <a href="index.html" class="home-button">Home</a>
        </div>
    </div>

    <div class="status-container">
        <p class="status-item"><span class="label">ETopH</span>= <span id="status-ETopH">Onbekend</span></p>
        <p class="status-item"><span class="label">ETopL</span>= <span id="status-ETopL">Onbekend</span></p>
        <p class="status-item"><span class="label">EMidH</span>= <span id="status-EMidH">Onbekend</span></p>
        <p class="status-item"><span class="label">EMidL</span>= <span id="status-EMidL">Onbekend</span></p>
        <p class="status-item"><span class="label">EBotH</span>= <span id="status-EBotH">Onbekend</span></p>
        <p class="status-item"><span class="label">EBotL</span>= <span id="status-EBotL">Onbekend</span></p>
        <p class="status-item"><span class="label">EAv</span>= <span id="status-EAv">Onbekend</span></p>
        <p class="status-item"><span class="label">EQtot</span>= <span id="status-EQtot-duplicate">Onbekend</span></p>
        <p class="status-item"><span class="label">Solar</span>= <span id="status-Solar">Onbekend</span></p>
        <p class="status-item"><span class="label">dT</span>= <span id="status-dT">Onbekend</span></p>
        <p class="status-item"><span class="label">dEQ</span>= <span id="status-dEQ">Onbekend</span></p>
        <p class="status-item"><span class="label">pwmVal</span>= <span id="status-pwmVal">Onbekend</span></p>
        <p class="status-item"><span class="label">Sun</span>= <span id="status-Sun">Onbekend</span></p>
        <p class="status-item"><span class="label">Relay</span>= <span id="status-Relay">Onbekend</span></p>
    </div>

<script>
// ==== TOKEN VEILIG OPHALEN VAN JE WORKER ====
let PARTICLE_TOKEN = null;
async function getToken() {
    if (PARTICLE_TOKEN) return PARTICLE_TOKEN;
    try {
        const res = await fetch('https://controllers-diagnose.filip-delannoy.workers.dev/token');
        const data = await res.json();
        PARTICLE_TOKEN = data.token;
        return PARTICLE_TOKEN;
    } catch (e) {
        console.error("Kon token niet ophalen!", e);
        alert("Geen verbinding met server – solar status niet beschikbaar");
        return null;
    }
}

const deviceId = '310049000f47343432313031'; // S-ECO-solar
const variables = ['ETopH','ETopL','EMidH','EMidL','EBotH','EBotL','EAv','EQtot','Solar','dT','dEQ','pwmVal','Sun','Relay'];

// Canvas contexten
const boilerCtx = document.getElementById('boilerCanvas').getContext('2d');
const sunCtx = document.getElementById('sunCanvas').getContext('2d');
const pumpCtx = document.getElementById('pumpCanvas').getContext('2d');
const graphCtx = document.getElementById('graphCanvas').getContext('2d');

let pumpAngle = 0;
let animationFrameId = null;
let eqtotHistory = [];

// Kleuren & animaties (exact zoals jij ze had)
function getColorForTemperature(temp) {
    const t = Math.min(Math.max(temp, 20), 60);
    const r = Math.round(173 + 2.05 * (t - 20));
    const g = Math.round(216 - 5.4 * (t - 20));
    const b = Math.round(230 - 5.75 * (t - 20));
    return `rgb(${r}, ${g}, ${b})`;
}
function getBackgroundColor(sunValue) {
    const sun = Math.min(Math.max(parseFloat(sunValue), 0), 4000);
    const ratio = sun / 4000;
    const r = Math.round(102 + (255 - 102) * ratio);
    const g = Math.round(102 + (255 - 102) * ratio);
    const b = Math.round(102 - (102 - 0) * ratio);
    return `rgba(${r}, ${g}, ${b}, 0.8)`;
}
function drawSun(solarTemp) { /* exact jouw code */ 
    const width = 100, height = 100, centerX = 50, centerY = 50, radius = 20, rayLength = 10;
    sunCtx.clearRect(0, 0, width, height);
    const color = getColorForTemperature(solarTemp || 20);
    sunCtx.fillStyle = color; sunCtx.beginPath(); sunCtx.arc(centerX, centerY, radius, 0, Math.PI * 2); sunCtx.fill();
    sunCtx.strokeStyle = '#000'; sunCtx.lineWidth = 1; sunCtx.stroke();
    sunCtx.lineWidth = 2;
    for (let i = 0; i < 8; i++) {
        const angle = (i * Math.PI) / 4;
        const startX = centerX + radius * Math.cos(angle);
        const startY = centerY + radius * Math.sin(angle);
        const endX = centerX + (radius + rayLength) * Math.cos(angle);
        const endY = centerY + (radius + rayLength) * Math.sin(angle);
        sunCtx.beginPath(); sunCtx.moveTo(startX, startY); sunCtx.lineTo(endX, endY); sunCtx.stroke();
    }
}
function drawPump(pwmVal, relay) { /* jouw volledige animatie */ 
    const width = 100, height = 100, centerX = 50, centerY = 50, radius = 20;
    pumpCtx.clearRect(0, 0, width, height);
    pumpCtx.fillStyle = relay === 1 ? 'rgba(255, 182, 193, 0.5)' : 'rgba(173, 216, 230, 0.5)';
    pumpCtx.beginPath(); pumpCtx.arc(centerX, centerY, radius, 0, Math.PI * 2); pumpCtx.fill();
    pumpCtx.strokeStyle = '#000'; pumpCtx.lineWidth = 2; pumpCtx.stroke();
    pumpCtx.fillStyle = '#666'; pumpCtx.save(); pumpCtx.translate(centerX, centerY); pumpCtx.rotate(pumpAngle);
    for (let i = 0; i < 6; i++) {
        pumpCtx.beginPath(); pumpCtx.moveTo(0, 0);
        const angle = (i * 2 * Math.PI) / 6;
        pumpCtx.quadraticCurveTo(10 * Math.cos(angle + Math.PI / 12), 10 * Math.sin(angle + Math.PI / 12), 15 * Math.cos(angle), 15 * Math.sin(angle));
        pumpCtx.lineTo(0, 0); pumpCtx.fill();
    }
    pumpCtx.restore();
    const rpm = (pwmVal / 255) * 20;
    const radiansPerSecond = (rpm * 2 * Math.PI) / 60;
    if (animationFrameId) cancelAnimationFrame(animationFrameId);
    if (radiansPerSecond > 0) {
        function animate() { pumpAngle += radiansPerSecond * (1 / 60); drawPump(pwmVal, relay); animationFrameId = requestAnimationFrame(animate); }
        animationFrameId = requestAnimationFrame(animate);
    }
}
function drawBoiler(temperatures) { /* jouw volledige boiler-tekening */ 
    const width = 150, height = 300, boilerWidth = 100, boilerHeight = 200, layerHeight = boilerHeight / 6;
    const x = (width - boilerWidth) / 2, y = (height - boilerHeight) / 2;
    boilerCtx.clearRect(0, 0, width, height);
    const layers = [
        { temp: temperatures.EBotL, label: 'EBotL' }, { temp: temperatures.EBotH, label: 'EBotH' },
        { temp: temperatures.EMidL, label: 'EMidL' }, { temp: temperatures.EMidH, label: 'EMidH' },
        { temp: temperatures.ETopL, label: 'ETopL' }, { temp: temperatures.ETopH, label: 'ETopH' }
    ];
    layers.forEach((layer, index) => {
        const layerY = y + (5 - index) * layerHeight;
        const color = getColorForTemperature(layer.temp || 20);
        boilerCtx.fillStyle = color; boilerCtx.fillRect(x, layerY, boilerWidth, layerHeight);
        boilerCtx.strokeStyle = '#000'; boilerCtx.lineWidth = 1; boilerCtx.strokeRect(x, layerY, boilerWidth, layerHeight);
        boilerCtx.fillStyle = '#000'; boilerCtx.font = '12px Arial'; boilerCtx.textAlign = 'center'; boilerCtx.textBaseline = 'middle';
        boilerCtx.shadowColor = 'white'; boilerCtx.shadowBlur = 3;
        boilerCtx.fillText(`${layer.temp || 'Onbekend'}°C`, x + boilerWidth / 2, layerY + layerHeight / 2);
        boilerCtx.shadowBlur = 0;
    });
}
function drawGraph() { /* jouw volledige grafiekfunctie */ 
    const width = 300, height = 150, padding = 20, graphWidth = width - 2 * padding, graphHeight = height - 2 * padding;
    graphCtx.clearRect(0, 0, width, height);
    graphCtx.strokeStyle = '#000'; graphCtx.lineWidth = 1;
    graphCtx.beginPath(); graphCtx.moveTo(padding, padding); graphCtx.lineTo(padding, height - padding); graphCtx.lineTo(width - padding, height - padding); graphCtx.stroke();
    const validData = eqtotHistory.filter(e => e.value !== null && !isNaN(e.value));
    if (validData.length === 0) {
        graphCtx.fillStyle = '#000'; graphCtx.font = '12px Arial'; graphCtx.textAlign = 'center'; graphCtx.textBaseline = 'middle';
        graphCtx.fillText('Geen data beschikbaar', width / 2, height / 2); return;
    }
    const values = validData.map(e => e.value);
    let minEQtot = Math.floor(Math.min(...values)), maxEQtot = Math.ceil(Math.max(...values));
    if (minEQtot === maxEQtot) { minEQtot--; maxEQtot++; }
    const range = maxEQtot - minEQtot;
    graphCtx.fillStyle = '#000'; graphCtx.font = '10px Arial'; graphCtx.textAlign = 'right'; graphCtx.textBaseline = 'middle';
    for (let i = minEQtot; i <= maxEQtot; i++) {
        const y = height - padding - ((i - minEQtot) / range) * graphHeight;
        graphCtx.fillText(i, padding - 5, y);
        graphCtx.beginPath(); graphCtx.moveTo(padding - 3, y); graphCtx.lineTo(padding, y); graphCtx.stroke();
    }
    graphCtx.textAlign = 'center'; graphCtx.fillText('kW', padding, padding - 10);
    const firstTime = validData[0].timestamp, lastTime = validData[validData.length - 1].timestamp;
    const timeSpanMinutes = (lastTime - firstTime) / (1000 * 60);
    if (timeSpanMinutes > 0) {
        const ppm = graphWidth / timeSpanMinutes;
        for (let m = 0; m <= Math.ceil(timeSpanMinutes); m++) {
            const x = padding + m * ppm;
            graphCtx.beginPath(); graphCtx.moveTo(x, height - padding); graphCtx.lineTo(x, height - padding + 5); graphCtx.stroke();
        }
    }
    graphCtx.strokeStyle = '#007bff'; graphCtx.lineWidth = 2; graphCtx.beginPath();
    let first = true;
    validData.forEach(e => {
        const timeSinceStart = (e.timestamp - firstTime) / (1000 * 60);
        const x = padding + (timeSpanMinutes > 0 ? (timeSinceStart / timeSpanMinutes) * graphWidth : graphWidth / 2);
        const y = height - padding - ((e.value - minEQtot) / range) * graphHeight;
        first ? graphCtx.moveTo(x, y) : graphCtx.lineTo(x, y);
        first = false;
    });
    graphCtx.stroke();
    graphCtx.fillStyle = '#007bff';
    validData.forEach(e => {
        const timeSinceStart = (e.timestamp - firstTime) / (1000 * 60);
        const x = padding + (timeSpanMinutes > 0 ? (timeSinceStart / timeSpanMinutes) * graphWidth : graphWidth / 2);
        const y = height - padding - ((e.value - minEQtot) / range) * graphHeight;
        graphCtx.beginPath(); graphCtx.arc(x, y, 3, 0, Math.PI * 2); graphCtx.fill();
    });
}

// Update alle waarden + teken alles
function updateStatus(data) {
    variables.forEach(v => {
        const el = document.getElementById(`status-${v}`);
        if (el) el.textContent = data[v] !== undefined ? data[v] : 'Onbekend';
    });
    const eqtotEl = document.getElementById('status-EQtot');
    eqtotEl.textContent = data.EQtot ?? 'Onbekend';
    eqtotEl.parentElement.style.color = (parseFloat(data.dEQ) > 0) ? 'red' : 'blue';
    document.getElementById('status-EQtot-duplicate').textContent = data.EQtot ?? 'Onbekend';
    document.getElementById('status-Solar-display').textContent = data.Solar ?? 'Onbekend';
    document.getElementById('status-pwmVal-display').textContent = data.pwmVal ?? 'Onbekend';

    const temps = [data.ETopH, data.ETopL, data.EMidH, data.EMidL, data.EBotH, data.EBotL].map(parseFloat).filter(t => !isNaN(t));
    const tgem = temps.length > 0 ? (temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1) : 'Onbekend';
    document.getElementById('status-Tgem').textContent = tgem;

    const sunValue = parseFloat(data.Sun);
    if (!isNaN(sunValue)) document.getElementById('boiler-container').style.backgroundColor = getBackgroundColor(sunValue);

    const eqtotValue = parseFloat(data.EQtot);
    if (!isNaN(eqtotValue)) eqtotHistory.push({ value: eqtotValue, timestamp: Date.now() });

    const temperatures = {
        ETopH: parseFloat(data.ETopH), ETopL: parseFloat(data.ETopL),
        EMidH: parseFloat(data.EMidH), EMidL: parseFloat(data.EMidL),
        EBotH: parseFloat(data.EBotH), EBotL: parseFloat(data.EBotL)
    };
    drawBoiler(temperatures);
    drawSun(parseFloat(data.Solar));
    drawPump(parseFloat(data.pwmVal) || 0, parseFloat(data.Relay) || 0);
    drawGraph();
}

// Haal JSON_temper op
async function fetchStatus() {
    const token = await getToken();
    if (!token) return;
    try {
        const resp = await fetch(`https://api.particle.io/v1/devices/${deviceId}/JSON_temper?access_token=${token}`);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const json = await resp.json();
        let result = json.result || json.body?.result;
        if (typeof result === "string") result = JSON.parse(result);
        if (!result) throw new Error("Geen data");
        updateStatus(result);
    } catch (err) {
        console.error("Fout solar status:", err);
        updateStatus({});
    }
}

// Live event stream voor "Solar" berichten
async function startEventStream() {
    const token = await getToken();
    if (!token) return;
    const es = new EventSource(`https://api.particle.io/v1/devices/${deviceId}/events/Solar?access_token=${token}`);
    es.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.data && data.published_at) {
                const timeStr = new Date(data.published_at).toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const li = document.createElement('li');
                li.textContent = `${timeStr} - ${data.data}`;
                const list = document.getElementById('message-list');
                list.insertBefore(li, list.firstChild);
                if (list.children.length > 10) list.removeChild(list.lastChild);
            }
        } catch (e) { console.error("Event parse fout:", e); }
    };
    es.onerror = () => {
        console.error("Event stream fout");
        es.close();
        addMessage("Event stream verbroken", new Date());
    };
}
function addMessage(msg, ts) {
    const li = document.createElement('li');
    li.textContent = `${new Date(ts).toLocaleTimeString('nl-BE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})} - ${msg}`;
    const list = document.getElementById('message-list');
    list.insertBefore(li, list.firstChild);
    if (list.children.length > 10) list.removeChild(list.lastChild);
}

// Start alles
fetchStatus();
startEventStream();
setInterval(fetchStatus, 10000); // elke 10 sec refresh
</script>
</body>
</html>
